    <script src="https://code.jquery.com/jquery-2.1.0.min.js"></script>

    <style>

    </style>

    <html>
    <center>
        <label for="yearSelector">Year:</label>

        <select name="yearSelector" id="yearSelector">
            <option value="0">All</option>
            <option value="1">First</option>
            <option value="2">Second</option>
            <option value="3">Third</option>
            <option value="4">Fourth</option>
        </select>
        <input type="text" id="mySearch" placeholder="Search for modules/subjects..">
        <table id='myTable'>
            <tr class="header">
                <th style='' id='subject' onClick>Subject</th>
                <th>Level</th>
                <th style=''>Module Title</th>
                <th style=''>Average First (%)</th>
                <th style=''>Average 2.1 (%)</th>
            </tr>
            
            <tbody id='moduleTableBody'>

            </tbody>
        </table>
    </center>
    </html>

    <script>
        function getFile() {
            $.get(
            'https://www.palatinate.org.uk/wp-content/uploadedImages/2020-Results.csv',
            function(data) {
                let rows = data.split('\n')
                for (let i = 1; i < rows.length; i++) {
                //for (let i = 2; i < 20; i++) {
                    cells = rows[i].split('|')
                    modName = cells[0].split('-')
                    let markup =  "<tr id='"+cells[0]+"''><td>"+modName[0]+"</td><td>"+modName[1][0]+
                        "</td><td><a target='_blank' rel='noreferrer noopener' href='https://www.dur.ac.uk/faculty.handbook/module_description/?year=2021&module_code="+modName[0]+modName[1]+"'>"
                            +cells[1]+"</a></td><td>"
                        +cells[4]+"</td><td>"+cells[5]+"</td></tr>"
                    $('#moduleTableBody').append(markup)
                }
            })
        }

        function comparer(index) {
            return function(a, b) {
                var valA = getCellValue(a, index), valB = getCellValue(b, index)
                if (valA[valA.length-1] === '%') {
                    return parseInt(valA.substring(0, valA.length-1)) - parseInt(valB.substring(0, valB.length-1))
                }
                return $.isNumeric(valA) && $.isNumeric(valB) ? valA - valB : valA.toString().localeCompare(valB)
            }
        }
        function getCellValue(row, index){ return $(row).children('td').eq(index).text() }
    

        function sortHeader() {
            $('th').on('click', function() {
                
                var table = $(this).parents('table').eq(0)
                var rows = table.find('tr:gt(0)').toArray().sort(comparer($(this).index()))
                this.asc = !this.asc
                if (!this.asc){rows = rows.reverse()}
                for (var i = 0; i < rows.length; i++){table.append(rows[i])}
            })
        }

        function searchTable () {
            $("#mySearch").on("keyup", function() {
                var search = $(this).val().toLowerCase();
                //console.log($("#moduleTableBody tr"))
                let year = $('#yearSelector').val()
                $("#moduleTableBody tr").filter(function() {
                    $(this).toggle(
                        ($(this).text().toLowerCase().indexOf(search) > -1 || $(this).attr('id').toLowerCase().indexOf(search) > -1) 
                            && 
                        ($(this).attr('id').toLowerCase().split('-')[1][0] === year || year === '0')
                    )
            });
    });
        }

        function filterYear() {
            $('#yearSelector').on('change', function() {
                let year = $(this).val()
                let search = $('#mySearch').val().toLowerCase();
                console.log($("#moduleTableBody tr"))
                if (year === '0') {
                    $("#moduleTableBody tr").filter(function() {
                        $(this).toggle($(this).text().toLowerCase().indexOf(search) > -1 || $(this).attr('id').toLowerCase().indexOf(search) > -1)
                    });
                } else {
                    $("#moduleTableBody tr").filter(function() {
                        $(this).toggle(
                            $(this).attr('id').toLowerCase().split('-')[1][0] === year
                                && 
                            ($(this).text().toLowerCase().indexOf(search) > -1 || $(this).attr('id').toLowerCase().indexOf(search) > -1)
                        )
                    })
                }
            })
        }
        
        $(document).ready(function() {
            getFile()
            sortHeader()
            searchTable()
            filterYear()
        })
    </script>

    <script>
    </script>
