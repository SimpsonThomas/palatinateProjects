<script src="https://code.jquery.com/jquery-2.1.0.min.js"></script>

<style>

</style>

<html>
<center>
    <label for="yearSelector">Year:</label>

    <select name="yearSelector" id="yearSelector">
        <option value="0">All</option>
        <option value="1">First</option>
        <option value="2">Second</option>
        <option value="3">Third</option>
        <option value="4">Fourth</option>
    </select>
    <input type="text" id="mySearch" placeholder="Search for modules/subjects..">
    <table id='myTable'>
        <tr class="header">
            <th style='' id='subject' onClick>Subject</th>
            <th style=''>meh</th>
            <th style=''>Title</th>
            <th style=''>1st</th>
          </tr>
          
          <tbody id='moduleTableBody'>

          </tbody>
    </table>
</center>
</html>

<script>
    function getFile() {
        $.get(
        'https://www.palatinate.org.uk/wp-content/uploadedImages/FOI-2018-422.csv',
        function(data) {
            //console.log(data)
            let rows = data.split('\n')
            //console.log(rows)
            for (let i = 3; i < 20; i++) {
                $('#testing').html(data)
                cells = rows[i].split(',')
                let markup =  "<tr id='"+cells[0]+'-'+cells[1]+"'><td>"+cells[0]+"</td><td>"+cells[1]+"</td><td>"+cells[2]+"</td><td>"+cells[6]+"</td></tr>"
                $('#moduleTableBody').append(markup)
            }
        })
    }

    function comparer(index) {
        return function(a, b) {
            var valA = getCellValue(a, index), valB = getCellValue(b, index)
            return $.isNumeric(valA) && $.isNumeric(valB) ? valA - valB : valA.toString().localeCompare(valB)
        }
    }
    function getCellValue(row, index){ return $(row).children('td').eq(index).text() }
   

    function sortHeader() {
        $('th').on('click', function() {
            var table = $(this).parents('table').eq(0)
            var rows = table.find('tr:gt(0)').toArray().sort(comparer($(this).index()))
            this.asc = !this.asc
            if (!this.asc){rows = rows.reverse()}
            for (var i = 0; i < rows.length; i++){table.append(rows[i])}
        })
    }

    function searchTable () {
        $("#mySearch").on("keyup", function() {
            
            var value = $(this).val().toLowerCase();
            let year = $('#yearSelector').val()
            $("#moduleTableBody tr").filter(function() {
                $(this).toggle(
                    ($(this).text().toLowerCase().indexOf(value) > -1) || $(this).toggle($(this).attr('id').toLowerCase.indexOf > -1) && $(this).attr('id').toLowerCase()[5] === value
                )
        });
});
    }

    function filterYear() {
        $('#yearSelector').on('change', function() {
            let value = $(this).val()
            let search = $('#mySearch').val().toLowerCase();
            if (value === '0') {
                $("#moduleTableBody tr").filter(function() {
                    $(this).toggle(true)
                });
            } else {
                console.log(value)
                $("#moduleTableBody tr").filter(function() {
                    $(this).toggle(
                        $(this).attr('id').toLowerCase()[5] === value && ($(this).text().toLowerCase().indexOf(value) > -1) || $(this).toggle($(this).attr('id').toLowerCase.indexOf > -1)
                    )
                })
            }
        })
    }
    
    $(document).ready(function() {
        getFile()
        sortHeader()
        searchTable()
        filterYear()
    })
</script>

<script>
</script>
